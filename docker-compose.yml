version: '3.8'

# ===========================================
# WHALE COPY TRADING - Docker Compose
# Production Configuration
# ===========================================
# Usage: docker-compose up -d
# Logs:  docker-compose logs -f
# Stop:  docker-compose down
# ===========================================

services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    image: postgres:15-alpine
    container_name: whale_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: whale_copy_trading
      # Performance tuning
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    # Production: Don't expose ports externally
    # ports:
    #   - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - whale_internal

  # ===========================================
  # Redis Cache & Message Broker
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: whale_redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    # Production: Don't expose ports externally
    # ports:
    #   - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - whale_internal

  # ===========================================
  # FastAPI Backend
  # ===========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: whale_backend
    restart: unless-stopped
    environment:
      # Database
      - DATABASE_URL=postgresql+asyncpg://postgres:${DB_PASSWORD}@postgres:5432/whale_copy_trading
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      # Security
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      # Telegram
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_WEBHOOK_URL=${TELEGRAM_WEBHOOK_URL}
      - TELEGRAM_WEBAPP_URL=${TELEGRAM_WEBAPP_URL}
      # Exchanges
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      - OKX_API_KEY=${OKX_API_KEY}
      - OKX_API_SECRET=${OKX_API_SECRET}
      - OKX_PASSPHRASE=${OKX_PASSPHRASE}
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      # Blockchain RPC
      - ETH_RPC_URL=${ETH_RPC_URL}
      - ETH_RPC_WS_URL=${ETH_RPC_WS_URL}
      - BSC_RPC_URL=${BSC_RPC_URL}
      # App settings
      - APP_ENV=production
      - DEBUG=false
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    # Production: Only expose via nginx
    expose:
      - "8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    # Production: Don't mount source code
    # volumes:
    #   - ./backend:/app
    command: >
      sh -c "alembic upgrade head &&
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4"
    networks:
      - whale_internal
    deploy:
      resources:
        limits:
          memory: 512M

  # ===========================================
  # Celery Worker (Trade Execution)
  # ===========================================
  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: whale_celery_worker
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:${DB_PASSWORD}@postgres:5432/whale_copy_trading
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      - OKX_API_KEY=${OKX_API_KEY}
      - OKX_API_SECRET=${OKX_API_SECRET}
      - OKX_PASSPHRASE=${OKX_PASSPHRASE}
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ETH_RPC_URL=${ETH_RPC_URL}
      - BSC_RPC_URL=${BSC_RPC_URL}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: celery -A app.workers.celery_app worker --loglevel=info --concurrency=4
    networks:
      - whale_internal
    deploy:
      resources:
        limits:
          memory: 512M

  # ===========================================
  # Celery Beat Scheduler
  # ===========================================
  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: whale_celery_beat
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:${DB_PASSWORD}@postgres:5432/whale_copy_trading
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: celery -A app.workers.celery_app beat --loglevel=info
    networks:
      - whale_internal
    deploy:
      resources:
        limits:
          memory: 128M

  # ===========================================
  # Flower - Celery Monitoring (Optional)
  # ===========================================
  flower:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: whale_flower
    restart: unless-stopped
    environment:
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - FLOWER_BASIC_AUTH=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin123}
    # Production: Access via VPN or authenticated proxy only
    ports:
      - "127.0.0.1:5555:5555"
    depends_on:
      redis:
        condition: service_healthy
    command: celery -A app.workers.celery_app flower --port=5555
    networks:
      - whale_internal
    profiles:
      - monitoring

  # ===========================================
  # Whale Monitor Service (Blockchain Listener)
  # ===========================================
  whale_monitor:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: whale_monitor
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:${DB_PASSWORD}@postgres:5432/whale_copy_trading
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - ETH_RPC_URL=${ETH_RPC_URL}
      - ETH_RPC_WS_URL=${ETH_RPC_WS_URL}
      - BSC_RPC_URL=${BSC_RPC_URL}
      - BSC_RPC_WS_URL=${BSC_RPC_WS_URL}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: python -m app.services.whale_monitor
    networks:
      - whale_internal
    deploy:
      resources:
        limits:
          memory: 256M

  # ===========================================
  # Frontend (Telegram Mini App - nginx)
  # ===========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=/api/v1
        - VITE_WS_URL=/ws
    container_name: whale_frontend
    restart: unless-stopped
    expose:
      - "80"
    depends_on:
      - backend
    networks:
      - whale_internal
    deploy:
      resources:
        limits:
          memory: 128M

  # ===========================================
  # Caddy (Reverse Proxy + Auto SSL)
  # ===========================================
  caddy:
    image: caddy:2-alpine
    container_name: whale_caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - caddy_logs:/var/log/caddy
    depends_on:
      - frontend
      - backend
    networks:
      - whale_internal
    deploy:
      resources:
        limits:
          memory: 128M

# ===========================================
# Volumes (Persistent Data)
# ===========================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local
  caddy_logs:
    driver: local

# ===========================================
# Networks
# ===========================================
networks:
  whale_internal:
    driver: bridge
    name: whale_network
